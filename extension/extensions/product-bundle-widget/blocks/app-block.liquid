<div
        class="bundle-widget-container"
        {{ block.shopify_attributes }}
        data-product-id="{{ product.id | prepend: 'gid://shopify/Product/' }}"
        data-shop="{{ shop.permanent_domain }}"
        data-app-url="{{ block.settings.app_url }}"
        data-layout="{{ block.settings.layout }}"
        data-show-savings="{{ block.settings.show_savings }}"
        data-show-images="{{ block.settings.show_product_images }}"
        data-theme="{{ block.settings.color_scheme }}"
        data-currency="{{ shop.currency }}"
        data-money-format="{{ shop.money_format }}"
>
    <div id="bundle-widget-{{ block.id }}" class="bundle-widget-content">
        <div class="bundle-widget-loading">
            <div class="bundle-loading-spinner"></div>
            <p>{{ block.settings.loading_text | default: 'Loading bundle options...' }}</p>
        </div>
    </div>
</div>

<style>
	.bundle-widget-container {
		margin: {{ block.settings.margin_top | default: 20 }}px 0 {{ block.settings.margin_bottom | default: 20 }}px 0;
		font-family: inherit;
		position: relative;
	}

	.bundle-widget {
		background: #ffffff;
		border: 1px solid #e1e5e9;
		border-radius: 12px;
		padding: 1.5rem;
		box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	}

	.bundle-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1.5rem;
		padding-bottom: 1rem;
		border-bottom: 1px solid #e1e5e9;
	}

	.bundle-title {
		margin: 0;
		font-size: 1.5rem;
		font-weight: 600;
		color: #333;
	}

	.bundle-savings {
		background: linear-gradient(135deg, #dc2626, #ef4444);
		color: white;
		padding: 0.5rem 1rem;
		border-radius: 20px;
		font-size: 0.875rem;
		font-weight: 700;
		box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
	}

	.bundle-products {
		margin: 1.5rem 0;
	}

	.bundle-products--grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
		gap: 1rem;
	}

	.bundle-products--list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.bundle-product {
		background: #f8f9fa;
		border: 2px solid #e9ecef;
		border-radius: 12px;
		padding: 1rem;
		transition: all 0.3s ease;
		position: relative;
	}

	.bundle-product:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0,0,0,0.1);
	}

	.bundle-product.current {
		border-color: #007c89;
		background: linear-gradient(135deg, #f0fdff, #e6fffa);
		box-shadow: 0 4px 12px rgba(0, 124, 137, 0.15);
	}

	.bundle-product.required {
		border-color: #007c89;
		background: linear-gradient(135deg, #f0fdff, #e6fffa);
	}

	.bundle-product-image {
		width: 80px;
		height: 80px;
		margin: 0 auto 0.75rem;
		border-radius: 8px;
		overflow: hidden;
		background: #f0f0f0;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.bundle-product-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.bundle-product-info {
		text-align: center;
	}

	.bundle-product-title {
		font-size: 0.9rem;
		font-weight: 600;
		color: #333;
		margin-bottom: 0.5rem;
		line-height: 1.3;
	}

	.bundle-product-price {
		font-size: 0.85rem;
		color: #666;
		margin-bottom: 0.5rem;
	}

	.bundle-product-price .original-price {
		text-decoration: line-through;
		color: #999;
		margin-right: 0.5rem;
	}

	.bundle-product-price .sale-price {
		color: #007c89;
		font-weight: 600;
	}

	.bundle-product-quantity {
		font-size: 0.8rem;
		color: #666;
		margin-bottom: 0.5rem;
	}

	.bundle-product-badge {
		font-size: 0.7rem;
		font-weight: 600;
		text-transform: uppercase;
		padding: 0.25rem 0.5rem;
		border-radius: 12px;
		display: inline-block;
	}

	.bundle-product-badge.required {
		background: #007c89;
		color: white;
	}

	.bundle-product-badge.optional {
		background: #6b7280;
		color: white;
	}

	.bundle-product-badge.current {
		background: #10b981;
		color: white;
	}

	.bundle-product-checkbox {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		width: 20px;
		height: 20px;
	}

	.bundle-pricing {
		background: linear-gradient(135deg, #f8f9fa, #e9ecef);
		padding: 1.5rem;
		border-radius: 12px;
		margin: 1.5rem 0;
		border: 2px dashed #007c89;
	}

	.bundle-pricing-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
	}

	.bundle-pricing-row:last-child {
		margin-bottom: 0;
		padding-top: 0.5rem;
		border-top: 1px solid #dee2e6;
		font-weight: 600;
		font-size: 1.1rem;
	}

	.bundle-pricing-label {
		color: #666;
	}

	.bundle-pricing-value {
		font-weight: 500;
	}

	.bundle-pricing-savings {
		color: #dc2626;
		font-weight: 600;
	}

	.bundle-actions {
		margin-top: 1.5rem;
		display: flex;
		gap: 1rem;
		align-items: center;
	}

	.bundle-add-to-cart {
		background: linear-gradient(135deg, #007c89, #0891b2);
		color: white;
		border: none;
		padding: 1rem 2rem;
		border-radius: 12px;
		font-size: 1rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.3s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		flex: 1;
		min-height: 48px;
	}

	.bundle-add-to-cart:hover:not(:disabled) {
		transform: translateY(-2px);
		box-shadow: 0 6px 16px rgba(0, 124, 137, 0.3);
	}

	.bundle-add-to-cart:disabled {
		opacity: 0.6;
		cursor: not-allowed;
		transform: none;
		box-shadow: none;
	}

	.bundle-add-to-cart.loading {
		pointer-events: none;
	}

	.bundle-btn-spinner {
		width: 20px;
		height: 20px;
		border: 2px solid rgba(255,255,255,0.3);
		border-radius: 50%;
		border-top-color: white;
		animation: bundle-spin 1s linear infinite;
	}

	.bundle-quantity-selector {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		background: white;
		border: 1px solid #e1e5e9;
		border-radius: 8px;
		padding: 0.5rem;
	}

	.bundle-quantity-btn {
		width: 32px;
		height: 32px;
		border: none;
		background: #f8f9fa;
		border-radius: 6px;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 600;
	}

	.bundle-quantity-input {
		width: 60px;
		text-align: center;
		border: none;
		font-weight: 500;
	}

	.bundle-messages {
		margin-top: 1rem;
	}

	.bundle-message {
		padding: 0.75rem 1rem;
		border-radius: 8px;
		margin-bottom: 0.5rem;
		font-weight: 500;
	}

	.bundle-message--success {
		background: #d1f2d1;
		color: #0f5f0f;
		border: 1px solid #a3d9a3;
	}

	.bundle-message--error {
		background: #fee;
		color: #c00;
		border: 1px solid #fcc;
	}

	.bundle-message--info {
		background: #d1ecf1;
		color: #0c5460;
		border: 1px solid #bee5eb;
	}

	.bundle-widget-loading {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 3rem 2rem;
		text-align: center;
		color: #666;
	}

	.bundle-loading-spinner {
		width: 40px;
		height: 40px;
		border: 3px solid #e1e5e9;
		border-radius: 50%;
		border-top-color: {{ block.settings.primary_color | default: '#007c89' }};
		animation: bundle-spin 1s linear infinite;
		margin-bottom: 1rem;
	}

	@keyframes bundle-spin {
		to { transform: rotate(360deg); }
	}

	.bundle-widget-hidden {
		display: none;
	}

	.bundle-widget-error {
		padding: 1.5rem;
		background: #fee;
		color: #c00;
		border: 1px solid #fcc;
		border-radius: 8px;
		text-align: center;
	}

	@media (max-width: 768px) {
		.bundle-widget {
			padding: 1rem;
			margin: 1rem 0;
		}

		.bundle-products--grid {
			grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
		}

		.bundle-actions {
			flex-direction: column;
		}

		.bundle-add-to-cart {
			width: 100%;
		}
	}
</style>

<script>
    (function() {
        function initBundleWidget() {
            try {
                var productId = '{{ product.id | prepend: "gid://shopify/Product/" | default: "" }}';
                var widgetContainer = document.querySelector('[data-product-id="' + productId + '"]');

                if (!productId || !widgetContainer) {
                    console.log('Bundle Widget: No product context or container found');
                    return;
                }

                if (widgetContainer.dataset.initialized) {
                    console.log('Bundle Widget: Already initialized');
                    return;
                }

                var appUrl = '{{ block.settings.app_url }}';
                if (!appUrl || appUrl.trim() === '') {
                    console.error('Bundle Widget: App URL not configured');
                    widgetContainer.innerHTML = '<div class="bundle-widget-error">Bundle Widget: Please configure the App URL in block settings.</div>';
                    return;
                }

                widgetContainer.dataset.initialized = 'true';
                console.log('Bundle Widget: Initializing for product:', productId);

                // Load widget script
                if (typeof ProductBundleWidget === 'undefined') {
                    var script = document.createElement('script');
                    script.src = appUrl + '/extensions/bundle-widget.js';
                    script.onload = function() {
                        console.log('Bundle Widget: Script loaded successfully');
                        if (typeof ProductBundleWidget !== 'undefined') {
                            new ProductBundleWidget(widgetContainer);
                        }
                    };
                    script.onerror = function() {
                        console.error('Bundle Widget: Failed to load script from:', script.src);
                        widgetContainer.innerHTML = '<div class="bundle-widget-error">Failed to load bundle widget. Please check your connection.</div>';
                    };
                    document.head.appendChild(script);
                } else {
                    new ProductBundleWidget(widgetContainer);
                }
            } catch (error) {
                console.error('Bundle Widget: Error in initBundleWidget:', error);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBundleWidget);
        } else {
            initBundleWidget();
        }
    })();
</script>

{% schema %}
{
	"name": "Product Bundle Widget",
	"target": "section",
	"settings": [
		{
			"type": "text",
			"id": "app_url",
			"label": "App URL",
			"info": "Your app's public URL (required)",
			"placeholder": "https://your-app-domain.ngrok.io"
		},
		{
			"type": "text",
			"id": "loading_text",
			"label": "Loading text",
			"default": "Loading bundle options..."
		},
		{
			"type": "color",
			"id": "primary_color",
			"label": "Primary color",
			"default": "#007c89"
		},
		{
			"type": "select",
			"id": "layout",
			"label": "Layout",
			"options": [
				{"value": "grid", "label": "Grid"},
				{"value": "list", "label": "List"}
			],
			"default": "grid"
		},
		{
			"type": "checkbox",
			"id": "show_savings",
			"label": "Show savings badge",
			"default": true
		},
		{
			"type": "checkbox",
			"id": "show_product_images",
			"label": "Show product images",
			"default": true
		},
		{
			"type": "number",
			"id": "margin_top",
			"label": "Top margin (px)",
			"default": 20
		},
		{
			"type": "number",
			"id": "margin_bottom",
			"label": "Bottom margin (px)",
			"default": 20
		}
	]
}
{% endschema %}