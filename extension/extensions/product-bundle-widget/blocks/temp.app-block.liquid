{% comment %}Debug info{% endcomment %}
<div style="background: yellow; padding: 10px; margin: 10px 0;">
    <strong>Debug Info:</strong><br>
    Product ID: {{ product.id }}<br>
    Shop: {{ shop.permanent_domain }}<br>
    App URL: {{ block.settings.app_url }}<br>
    Block ID: {{ block.id }}
</div>

<div
        class="bundle-widget-container"
        data-product-id="{{ product.id | prepend: 'gid://shopify/Product/' }}"
        data-shop="{{ shop.permanent_domain }}"
        data-app-url="{{ block.settings.app_url }}"
        data-layout="{{ block.settings.layout }}"
        data-show-savings="{{ block.settings.show_savings }}"
        data-show-images="{{ block.settings.show_product_images }}"
        data-theme="{{ block.settings.color_scheme }}"
>
    <div id="bundle-widget-{{ block.id }}" class="bundle-widget-content">
        <div class="bundle-widget-loading">
            <div class="bundle-loading-spinner"></div>
            <p>{{ block.settings.loading_text | default: 'Loading bundle options...' }}</p>
        </div>
    </div>
</div>

<style>
	.bundle-widget-container {
		margin: {{ block.settings.margin_top | default: 20 }}px 0 {{ block.settings.margin_bottom | default: 20 }}px 0;
		font-family: inherit;
	}

	.bundle-widget-loading {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 2rem;
		text-align: center;
		color: #666;
	}

	.bundle-loading-spinner {
		width: 32px;
		height: 32px;
		border: 3px solid #e1e5e9;
		border-radius: 50%;
		border-top-color: {{ block.settings.primary_color | default: '#007c89' }};
		animation: bundle-spin 1s linear infinite;
		margin-bottom: 1rem;
	}

	@keyframes bundle-spin {
		to { transform: rotate(360deg); }
	}
</style>

<script>
    (function() {
        function initBundleWidget() {
            try {
                var productId = '{{ product.id | prepend: "gid://shopify/Product/" }}';
                var widgetContainer = document.querySelector('[data-product-id="' + productId + '"]');

                if (widgetContainer && !widgetContainer.dataset.initialized) {
                    widgetContainer.dataset.initialized = 'true';

                    // Get app URL from the current tunnel (works with auto-update)
                    var appUrl = '{{ 'https://' | append: request.host }}';

                    // Fallback to manual setting if needed
                    if (widgetContainer.dataset.appUrl && widgetContainer.dataset.appUrl !== 'https://your-app-domain.com') {
                        appUrl = widgetContainer.dataset.appUrl;
                    }

                    console.log('Using app URL:', appUrl);

                    if (typeof ProductBundleWidget === 'undefined') {
                        var script = document.createElement('script');
                        script.src = appUrl + '/extensions/bundle-widget.js';
                        script.onload = function() {
                            if (typeof ProductBundleWidget !== 'undefined') {
                                new ProductBundleWidget(widgetContainer);
                            }
                        };
                        script.onerror = function() {
                            console.error('Failed to load script from:', script.src);
                        };
                        document.head.appendChild(script);

                        var link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = appUrl + '/extensions/bundle-widget.css';
                        document.head.appendChild(link);
                    } else {
                        new ProductBundleWidget(widgetContainer);
                    }
                }
            } catch (error) {
                console.error('Error in initBundleWidget:', error);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBundleWidget);
        } else {
            initBundleWidget();
        }
    })();
</script>

{% schema %}
{
	"name": "Product Bundle Widget",
	"target": "section",
	"settings": [
		{
			"type": "text",
			"id": "app_url",
			"label": "App URL (optional)",
			"info": "Leave blank to auto-detect. Only set if auto-detection fails.",
			"placeholder": "https://your-app-domain.com"
		},
		{
			"type": "text",
			"id": "loading_text",
			"label": "Loading text",
			"default": "Loading bundle options..."
		},
		{
			"type": "color",
			"id": "primary_color",
			"label": "Primary color",
			"default": "#007c89"
		}
	]
}
{% endschema %}